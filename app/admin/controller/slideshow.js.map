{
    "version": 3,
    "sources": [
        "..\\..\\..\\src\\admin\\controller\\slideshow.js"
    ],
    "names": [
        "pagination",
        "require",
        "fs",
        "path",
        "helper",
        "Base",
        "Jimp",
        "qiniu",
        "module",
        "exports",
        "constructor",
        "args",
        "modelInstance",
        "model",
        "indexAction",
        "pageIndex",
        "get",
        "data",
        "slideList",
        "page_data",
        "ctx",
        "desc",
        "pageNum",
        "url",
        "class",
        "text",
        "next",
        "prev",
        "total",
        "assign",
        "display",
        "addAction",
        "slideId",
        "slideData",
        "where",
        "find",
        "uploadImgAction",
        "file",
        "type",
        "filepath",
        "nameArr",
        "name",
        "split",
        "basename",
        "length",
        "YYYYMMDD",
        "datetime",
        "Date",
        "now",
        "staticPath",
        "resolve",
        "think",
        "ROOT_PATH",
        "uploadSlidePath",
        "uploadPath",
        "relativePath",
        "existsSync",
        "mkdirSync",
        "renameSync",
        "datuPath",
        "read",
        "then",
        "lenna",
        "cover",
        "quality",
        "autocrop",
        "write",
        "catch",
        "err",
        "console",
        "error",
        "json",
        "success",
        "errmsg",
        "img_path",
        "img_path_thumb",
        "title",
        "original",
        "uploadQiniuAction",
        "localFile",
        "slideshow",
        "service",
        "result",
        "putfileQiniu",
        "msg",
        "addslideAction",
        "isGet",
        "param",
        "editId",
        "descrition",
        "jumpUrl",
        "is_slide",
        "isslide",
        "reg",
        "fail",
        "test",
        "slide_title",
        "slide_img",
        "slide_text",
        "slide_jumpurl",
        "slide_thumb",
        "field",
        "deleteQiniuImg",
        "editSlide",
        "isSlide",
        "count",
        "addSlide",
        "deleteAction",
        "dataId",
        "delete",
        "setslideAction",
        "id",
        "thisRecord",
        "update",
        "cleanImgAction",
        "imgUrl",
        "select"
    ],
    "mappings": "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",
    "file": "..\\..\\..\\src\\admin\\controller\\slideshow.js",
    "sourcesContent": [
        "/*\r\n* 图片上传 上传至七牛，不在上传至本地文件夹\r\n* 百度编辑器上传的图片目前还是只能存在本地目录，\r\n* 轮播图和新闻的缩略图是存在七牛\r\n* */\r\n\r\nconst pagination = require('think-pagination');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst helper = require('think-helper');\r\nconst Base = require('./base.js');\r\nconst Jimp = require(\"jimp\");\r\nconst qiniu=require('qiniu');\r\n\r\nmodule.exports = class extends Base {\r\n    /*\r\n     * 构造函数 便于使用model文件\r\n     * */\r\n    constructor(...args) {\r\n        super(...args);//调用父级的 constructor 方法\r\n        this.modelInstance = this.model('slideshow'); //增加一个方法\r\n    }\r\n  /*图片列表*/\r\n  async indexAction() {\r\n      //分页查询列表\r\n      let pageIndex=this.get('page');\r\n      const data = await this.modelInstance.slideList(pageIndex);   ////  两个表的字段重复了\r\n      const page_data = pagination(data, this.ctx, {\r\n          desc: false, //show description\r\n          pageNum: 2,\r\n          url: '', //page url, when not set, it will auto generated\r\n          class: '', //pagenation extra class\r\n          text: {\r\n              next: '下一页',\r\n              prev: '上一页',\r\n              total: 'count: __COUNT__ , pages: __PAGE__'\r\n          }\r\n      });\r\n      this.assign({'pagination':page_data,'slide_list':data.data});\r\n      return this.display();\r\n  }\r\n  /*\r\n  * 增加图片\r\n  * */\r\n    async addAction(){\r\n        let slideId=this.get('slide-id');\r\n        if(slideId){//有文章id 则是编辑页面 根据id查询数据\r\n            let slideData=await this.modelInstance.where({'slide_id':slideId}).find();\r\n            this.assign('slideData',slideData);\r\n        }\r\n\r\n        return this.display();\r\n    }\r\n    /*\r\n    * 单图异步上传到本地文件夹（弃用）\r\n    * */\r\n    async uploadImgAction(){\r\n        let file=this.ctx.file('file');//获取文件\r\n\r\n        if(file && file.type === 'image/png' || file.type === 'image/jpeg') {\r\n            const filepath = file.path;\r\n            const nameArr = file.name.split('.');\r\n            const basename = path.basename(filepath) + '.' + nameArr[nameArr.length - 1];\r\n            const YYYYMMDD = helper.datetime(Date.now(), 'YYYYMMDD');\r\n            const staticPath = path.resolve(think.ROOT_PATH, 'www/static');\r\n            const uploadSlidePath=path.resolve(staticPath, 'upload');\r\n            const uploadPath = path.resolve(uploadSlidePath, 'slideshow');\r\n            const relativePath = path.resolve(uploadPath, YYYYMMDD);\r\n\r\n            // 文件夹不存在则创建\r\n            if (!fs.existsSync(uploadSlidePath)) {\r\n                fs.mkdirSync(uploadSlidePath);\r\n            }\r\n            if (!fs.existsSync(uploadPath)) {\r\n                fs.mkdirSync(uploadPath);\r\n            }\r\n\r\n            if (!fs.existsSync(relativePath)) {\r\n                fs.mkdirSync(relativePath);\r\n            }\r\n\r\n            fs.renameSync(filepath, path.resolve(relativePath, `${basename}`));\r\n\r\n            let datuPath=`${think.ROOT_PATH}/www/static/upload/slideshow/${YYYYMMDD}/${basename}`;\r\n\r\n            if(datuPath){\r\n\t            //处理缩略图\r\n\t            Jimp.read(datuPath).then(function (lenna) {\r\n\t\t            lenna.cover(320,320)     // resize\r\n\t\t            .quality(60)         // set JPEG quality\r\n\t\t            .autocrop()\r\n\t\t            .write(`${think.ROOT_PATH}/www/static/upload/slideshow/${YYYYMMDD}/${path.basename(filepath)}_thumb.${nameArr[nameArr.length - 1]}`); // save\r\n\t            }).catch(function (err) {\r\n\t\t            console.error(err);\r\n\t            });\r\n            }\r\n\r\n            this.json({\r\n                success:true,\r\n                errmsg:'上传成功',\r\n                data:{\r\n                    img_path:`/static/upload/slideshow/${YYYYMMDD}/${basename}`,\r\n                    img_path_thumb:`/static/upload/slideshow/${YYYYMMDD}/${path.basename(filepath)}_thumb.${nameArr[nameArr.length - 1]}`,\r\n                    title: basename,\r\n                    original: file.name\r\n                }\r\n            });\r\n\r\n        }else{\r\n            this.json({\r\n                success:true,\r\n                errmsg:'上传失败',\r\n                data:[]\r\n            });\r\n        }\r\n\r\n    }\r\n    /*\r\n    * 上传图片到七牛服务器\r\n    * */\r\n    async uploadQiniuAction(){\r\n\t    let file=this.ctx.file('file');//获取文件\r\n\t    if(file && file.type === 'image/png' || file.type === 'image/jpeg'){\r\n\t\t    let localFile = file.path;//上传文件\r\n\t\t    const nameArr = file.name.split('.');\r\n\t\t    const YYYYMMDD = helper.datetime(Date.now(), 'YYYYMMDD');\r\n\t\t    const basename = 'slide_'+YYYYMMDD+'_'+path.basename(localFile) + '.' + nameArr[nameArr.length - 1]; //新名称\r\n\t\t    // 文件上传\r\n\t\t    let slideshow=think.service('slideshow', 'admin');\r\n\t\t    let result=await slideshow.putfileQiniu(localFile, basename);\r\n\t\t    if(result.msg=='success'){\r\n\t\t    \t//上传成功\r\n\r\n\t\t\t    this.json({\r\n\t\t\t\t    success:true,\r\n\t\t\t\t    errmsg:'上传成功',\r\n\t\t\t\t    data:result.data\r\n\t\t\t    });\r\n\t\t    }else if(result.msg=='error_1'){\r\n\t\t\t    this.json({\r\n\t\t\t\t    success:false,\r\n\t\t\t\t    errmsg:'上传失败',\r\n\t\t\t\t    data:[]\r\n\t\t\t    });\r\n\t\t    }else{\r\n\t\t\t    this.json({\r\n\t\t\t\t    success:false,\r\n\t\t\t\t    errmsg:'上传失败',\r\n\t\t\t\t    data:result.data\r\n\t\t\t    });\r\n\t\t    }\r\n\r\n\t    }else {\r\n\t\t    this.json({\r\n\t\t     success:false,\r\n\t\t     errmsg:'上传失败',\r\n\t\t     data:[]\r\n\t\t     });\r\n\t    }\r\n\r\n    }\r\n\r\n    /*\r\n    * 文字和图片路径提交 存储\r\n    * */\r\n    async addslideAction(){\r\n        const isGet = this.ctx.isGet;\r\n        const param = this.ctx.param();\r\n\r\n        if(isGet){\r\n            let editId=param.editId;\r\n            let title=param.title;\r\n            let descrition=param.descrition;\r\n            let jumpUrl=param.jumpUrl;\r\n            let img_path=param.img_path;\r\n            let img_path_thumb=param.img_path_thumb;\r\n            let is_slide=param.isslide;\r\n\t        var reg=/^([hH][tT]{2}[pP]:\\/\\/|[hH][tT]{2}[pP][sS]:\\/\\/)(([A-Za-z0-9-~]+)\\.)+([A-Za-z0-9-~\\/])+$/;\r\n            if(!title || title==''){\r\n                this.fail(403,'轮播图标题不能为空');\r\n                return false;\r\n            }\r\n            if(!jumpUrl || jumpUrl==''){\r\n                this.fail(403,'轮播图跳转链接不能为空');\r\n                return false;\r\n            }\r\n            if(!reg.test(jumpUrl) &&jumpUrl!='#'){\r\n\t            this.fail(403,'请输入正确的轮播图跳转链接');\r\n\t            return false;\r\n            }\r\n            if(!img_path||img_path==''){\r\n                this.fail(403,'请先上传图片');\r\n                return false;\r\n            }\r\n            let data={\r\n                slide_title:title,\r\n                slide_img:img_path,\r\n                slide_text:descrition,\r\n                slide_jumpurl:jumpUrl,\r\n                slide_thumb:img_path_thumb,\r\n\t            is_slide:is_slide\r\n            };\r\n\r\n\r\n            if(editId!=0 || editId!='0'){//编辑\r\n                //首先先把本地已经上传的图片删掉 然后再更新数据库数据\r\n                let slide_img=await this.modelInstance.where({'slide_id':editId}).field('slide_img').find();\r\n                if(img_path!=slide_img.slide_img){ //如果提交过来的图片路径和数据库的不一致，则是修改了图片\r\n                    // 检测文件是否存在\r\n                    /*let filePath=think.ROOT_PATH+'/www'+slide_img.slide_img;  //图片的路径\r\n                    if(fs.existsSync(filePath)) { //如果存在则删除图片\r\n                        fs.unlinkSync(filePath);\r\n                    }*/\r\n                    //从先删除已经存在的图片\r\n\t                let slideshow=think.service('slideshow', 'admin');\r\n\t                let result=await slideshow.deleteQiniuImg(slide_img.slide_img);\r\n\r\n                }\r\n\r\n                //更新数据\r\n                let slideId=await this.modelInstance.where({'slide_id':editId}).editSlide(data);\r\n                let isSlide=await this.modelInstance.where({'is_slide':'1'}).field('is_slide').count(); //设置为轮播图的数量 最多只能设置5\r\n\t            if(isSlide>=5){\r\n\t\t            this.fail(403,'轮播图最多只能设置5个，请先取消其他已设置的轮播图');\r\n\t\t            return false\r\n\t            }\r\n\r\n                if(!slideId){\r\n                    this.fail(403,'编辑文章失败');\r\n                }\r\n                else{\r\n                    this.success({data:slideId},'编辑文章成功');\r\n                }\r\n            }else{//新增\r\n                let slideId=await this.modelInstance.addSlide(data);\r\n\t            let isSlide=await this.modelInstance.where({'is_slide':'1'}).field('is_slide').count(); //设置为轮播图的数量 最多只能设置5\r\n\t            if(isSlide>=5){\r\n\t\t            this.fail(403,'轮播图最多只能设置5个，请先取消其他已设置的轮播图');\r\n\t\t            return false\r\n\t            }\r\n                if(!slideId){\r\n                    this.fail(403,'添加轮播图失败');\r\n                }\r\n                else{\r\n                    this.success({data:slideId},'添加轮播图成功');\r\n                }\r\n            }\r\n\r\n\r\n        }else{\r\n            this.fail(403,'请使用get方法');\r\n        }\r\n    }\r\n    /*\r\n    * 删除图片记录 @同时需要删除对应的已经上传的图片\r\n    * */\r\n    async deleteAction(){\r\n        if(this.isGet){\r\n            let slideId=this.ctx.param('slide-id');\r\n            //let slide_img=await this.modelInstance.where({'slide_id':slideId}).field('slide_img,slide_thumb').find();\r\n\r\n            //循环遍历对象\r\n\t        /*if(slide_img){\r\n\t\t        for (let i in slide_img) {\r\n\t\t\t        if (slide_img.hasOwnProperty(i) === true) {\r\n\t\t\t\t        // 检测文件是否存在 删除大图和缩略图\r\n\t\t\t\t        let filePath=think.ROOT_PATH+'/www'+slide_img[i];  //图片的路径\r\n\t\t\t\t        if(fs.existsSync(filePath)) { //如果存在则删除图片\r\n\t\t\t\t\t        fs.unlinkSync(filePath);\r\n\t\t\t\t        }\r\n\t\t\t        }\r\n\t\t        }\r\n\t        }*/\r\n\t        let slide_img=await this.modelInstance.where({'slide_id':slideId}).field('slide_img').find();\r\n\t        //去七牛删除文件\r\n\t        let slideshow=think.service('slideshow', 'admin');\r\n\t        //当删除七牛图片成功时才删除数据库记录\r\n\t        let result=await slideshow.deleteQiniuImg(slide_img.slide_img);  //只取 除域名外的部分\r\n\r\n\t        if(result.msg!='success'){\r\n\t\t        this.fail(403,'删除轮播图失败');\r\n\t        \treturn false;\r\n\t        }\r\n\r\n            let dataId=await this.modelInstance.where({'slide_id':slideId}).delete();\r\n            if(!dataId){\r\n                this.fail(403,'删除轮播图失败');\r\n            }\r\n            else{\r\n                this.success({data:dataId},'删除轮播图成功');\r\n            }\r\n        }\r\n    }\r\n    /*\r\n    * 设置为轮播图\r\n    * */\r\n    async setslideAction(){\r\n    \tlet id=this.get('slide-id');\r\n    \tlet is_slide=this.get('is_slide');\r\n    \tif(is_slide=='1'){\r\n\t\t    let isSlide=await this.modelInstance.where({'is_slide':'1'}).field('is_slide').count(); //设置为轮播图的数量 最多只能设置5\r\n\t\t    if(isSlide>=5){\r\n\t\t\t    this.fail(403,'轮播图最多只能设置5个，请先取消其他已设置的轮播图');\r\n\t\t\t    return false;\r\n\t\t    }\r\n\t    }\r\n    \tlet thisRecord=await this.modelInstance.where({'slide_id':id}).update({'is_slide':is_slide});\r\n\t    if(!thisRecord){\r\n\t\t    this.fail(403,'更改轮播图状态失败');\r\n\t    }\r\n\t    else{\r\n\t\t    this.success({data:thisRecord},'更改轮播图状态成功');\r\n\t    }\r\n    }\r\n    /*\r\n    * 关闭浏览器时若没有点击提交按钮，则清除已经上传的图片\r\n    * */\r\n    async cleanImgAction(){\r\n    \tlet imgUrl=this.get('imgUrl');\r\n    \tif(!imgUrl){\r\n    \t\treturn false;\r\n\t    }\r\n\t    let slide_img=await this.modelInstance.where({'slide_img':imgUrl}).select();\r\n\r\n\t    if(slide_img.length<=0){ //如果数据库里找不到，则是用户还没保存此文章，那么此时用户离开了浏览器，则需要删除七牛的已经上传的文件\r\n\t\t    let slideshow=think.service('slideshow', 'admin');\r\n\t\t    let result=await slideshow.deleteQiniuImg(imgUrl);\r\n\t    }\r\n\r\n    }\r\n\r\n};\r\n\r\n"
    ]
}