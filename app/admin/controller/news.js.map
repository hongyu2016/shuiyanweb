{
    "version": 3,
    "sources": [
        "..\\..\\..\\src\\admin\\controller\\news.js"
    ],
    "names": [
        "ThinkUeditor",
        "require",
        "pagination",
        "fs",
        "path",
        "helper",
        "Jimp",
        "qiniu",
        "Base",
        "module",
        "exports",
        "constructor",
        "args",
        "modelInstance",
        "model",
        "indexAction",
        "pageIndex",
        "get",
        "data",
        "indexList",
        "html",
        "ctx",
        "desc",
        "pageNum",
        "url",
        "class",
        "text",
        "next",
        "prev",
        "total",
        "assign",
        "display",
        "addAction",
        "sortList",
        "select",
        "newsId",
        "newsData",
        "where",
        "find",
        "uploadAction",
        "ueditor",
        "json",
        "init",
        "uploadImgAction",
        "file",
        "type",
        "filepath",
        "nameArr",
        "name",
        "split",
        "basename",
        "length",
        "YYYYMMDD",
        "datetime",
        "Date",
        "now",
        "staticPath",
        "resolve",
        "think",
        "ROOT_PATH",
        "uploadSlidePath",
        "uploadPath",
        "relativePath",
        "existsSync",
        "mkdirSync",
        "renameSync",
        "datuPath",
        "read",
        "then",
        "lenna",
        "cover",
        "quality",
        "autocrop",
        "write",
        "catch",
        "err",
        "console",
        "error",
        "success",
        "errmsg",
        "img_path",
        "img_path_thumb",
        "title",
        "original",
        "uploadQiniuAction",
        "localFile",
        "slideshow",
        "service",
        "result",
        "putfileQiniu",
        "msg",
        "doaddAction",
        "isPost",
        "editId",
        "post",
        "sort",
        "subTitle",
        "intro",
        "author",
        "content",
        "copyfrom",
        "thumb",
        "fail",
        "newsThumb",
        "field",
        "deleteQiniuImg",
        "artitleId",
        "editNews",
        "addArticle",
        "deleteAction",
        "isGet",
        "news_img",
        "i",
        "hasOwnProperty",
        "filePath",
        "unlinkSync",
        "dataId",
        "delete",
        "cleanImgAction",
        "imgUrl",
        "slide_img"
    ],
    "mappings": "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",
    "file": "..\\..\\..\\src\\admin\\controller\\news.js",
    "sourcesContent": [
        "//const ThinkUeditor=require('think-ueditor');\nconst ThinkUeditor=require('../common_function/ueditor/index');  //引入本地的文件 方便修改配置 **百度编辑器\nconst pagination = require('think-pagination');\nconst fs = require('fs');\nconst path = require('path');\nconst helper = require('think-helper');\nconst Jimp = require(\"jimp\");\nconst qiniu=require('qiniu');\n//import commonFun from \"../common_function/common_function.js\";//自定义类 里面有自定义函数\nconst Base = require('./base.js');\n\nmodule.exports = class extends Base {\n    /*\n     * 构造函数 便于使用model文件\n     * */\n    constructor(...args) {\n        super(...args);//调用父级的 constructor 方法\n        this.modelInstance = this.model('news'); //增加一个方法\n    }\n  /*文章列表*/\n  async indexAction() {\n      //分页查询列表\n      let pageIndex=this.get('page');\n      const data = await this.modelInstance.indexList(pageIndex);\n      const html = pagination(data, this.ctx, {\n          desc: false, //show description\n          pageNum: 2,\n          url: '', //page url, when not set, it will auto generated\n          class: '', //pagenation extra class\n          text: {\n              next: '下一页',\n              prev: '上一页',\n              total: 'count: __COUNT__ , pages: __PAGE__'\n          }\n      });\n      this.assign({'pagination':html,'news_list':data});\n      return this.display();\n  }\n  /*\n  * 发布新闻显示页面\n  * */\n    async addAction(){\n        let sortList=await this.model('news_sort').select();\n        this.assign('sortList',sortList);\n        let newsId=this.get('news-id');\n        if(newsId){//有文章id 则是编辑页面 从news表根据id查询数据\n            let newsData=await this.modelInstance.where({'article_id':newsId}).find();\n            this.assign('newsData',newsData);\n        }\n        return this.display();\n    }\n    uploadAction(){\n        //百度编辑器\n        const ueditor = new ThinkUeditor(this.ctx);\n        this.json(ueditor.init());\n    }\n    /*\n    * 缩略图上传到本地文件夹（弃用）\n    * */\n\tasync uploadImgAction(){\n\t\tlet file=this.ctx.file('file');//获取文件\n\n\t\tif(file && file.type === 'image/png' || file.type === 'image/jpeg') {\n\t\t\tconst filepath = file.path;\n\t\t\tconst nameArr = file.name.split('.');\n\t\t\tconst basename = path.basename(filepath) + '.' + nameArr[nameArr.length - 1];\n\t\t\tconst YYYYMMDD = helper.datetime(Date.now(), 'YYYYMMDD');\n\t\t\tconst staticPath = path.resolve(think.ROOT_PATH, 'www/static');\n\t\t\tconst uploadSlidePath=path.resolve(staticPath, 'upload');\n\t\t\tconst uploadPath = path.resolve(uploadSlidePath, 'news');\n\t\t\tconst relativePath = path.resolve(uploadPath, YYYYMMDD);\n\n\t\t\t// 文件夹不存在则创建\n\t\t\tif (!fs.existsSync(uploadSlidePath)) {\n\t\t\t\tfs.mkdirSync(uploadSlidePath);\n\t\t\t}\n\t\t\tif (!fs.existsSync(uploadPath)) {\n\t\t\t\tfs.mkdirSync(uploadPath);\n\t\t\t}\n\n\t\t\tif (!fs.existsSync(relativePath)) {\n\t\t\t\tfs.mkdirSync(relativePath);\n\t\t\t}\n\n\t\t\tfs.renameSync(filepath, path.resolve(relativePath, `${basename}`));\n\n\t\t\tlet datuPath=`${think.ROOT_PATH}/www/static/upload/news/${YYYYMMDD}/${basename}`;\n\n\t\t\tif(datuPath){\n\t\t\t\t//处理缩略图\n\t\t\t\tJimp.read(datuPath).then(function (lenna) {\n\t\t\t\t\tlenna.cover(320,320)     // resize\n\t\t\t\t\t.quality(60)         // set JPEG quality\n\t\t\t\t\t.autocrop()\n\t\t\t\t\t.write(`${think.ROOT_PATH}/www/static/upload/news/${YYYYMMDD}/${path.basename(filepath)}.${nameArr[nameArr.length - 1]}`); // 另存为图片文件，在这里 文件名和上传文件名一致，覆盖原图 只存缩略图，不需要原图\n\t\t\t\t}).catch(function (err) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis.json({\n\t\t\t\tsuccess:true,\n\t\t\t\terrmsg:'上传成功',\n\t\t\t\tdata:{\n\t\t\t\t\timg_path:`/static/upload/news/${YYYYMMDD}/${basename}`,\n\t\t\t\t\timg_path_thumb:`/static/upload/news/${YYYYMMDD}/${path.basename(filepath)}.${nameArr[nameArr.length - 1]}`,\n\t\t\t\t\ttitle: basename,\n\t\t\t\t\toriginal: file.name\n\t\t\t\t}\n\t\t\t});\n\n\t\t}else{\n\t\t\tthis.json({\n\t\t\t\tsuccess:true,\n\t\t\t\terrmsg:'上传失败',\n\t\t\t\tdata:[]\n\t\t\t});\n\t\t}\n\t}\n\t/*\n\t * 上传图片到七牛服务器\n\t * */\n\tasync uploadQiniuAction(){\n\t\tlet file=this.ctx.file('file');//获取文件\n\t\tif(file && file.type === 'image/png' || file.type === 'image/jpeg'){\n\t\t\tlet localFile = file.path;//上传文件\n\t\t\tconst nameArr = file.name.split('.');\n\t\t\tconst YYYYMMDD = helper.datetime(Date.now(), 'YYYYMMDD');\n\t\t\tconst basename = 'news_'+YYYYMMDD+'_'+path.basename(localFile) + '.' + nameArr[nameArr.length - 1]; //新名称\n\t\t\t// 文件上传\n\t\t\tlet slideshow=think.service('slideshow', 'admin');\n\t\t\tlet result=await slideshow.putfileQiniu(localFile, basename);\n\t\t\tif(result.msg=='success'){\n\t\t\t\t//上传成功\n\n\t\t\t\tthis.json({\n\t\t\t\t\tsuccess:true,\n\t\t\t\t\terrmsg:'上传成功',\n\t\t\t\t\tdata:result.data\n\t\t\t\t});\n\t\t\t}else if(result.msg=='error_1'){\n\t\t\t\tthis.json({\n\t\t\t\t\tsuccess:true,\n\t\t\t\t\terrmsg:'上传失败',\n\t\t\t\t\tdata:[]\n\t\t\t\t});\n\t\t\t}else{\n\t\t\t\tthis.json({\n\t\t\t\t\tsuccess:true,\n\t\t\t\t\terrmsg:'上传失败',\n\t\t\t\t\tdata:result.data\n\t\t\t\t});\n\t\t\t}\n\n\t\t}else {\n\t\t\tthis.json({\n\t\t\t\tsuccess:true,\n\t\t\t\terrmsg:'上传失败',\n\t\t\t\tdata:[]\n\t\t\t});\n\t\t}\n\n\t}\n\n    /*\n    * 提交新增/编辑文章\n    * */\n    async doaddAction(){\n        if(this.isPost){\n            let editId=this.post('editId');\n            let sort=this.post('sort');\n            let title=this.post('title');\n            let subTitle=this.post('subTitle');\n            let intro=this.post('intro');\n            let author=this.post('author');\n            let content=this.post('content');\n            let copyfrom=this.post('copyfrom');\n            let thumb=this.post('img_path_thumb');\n            if(!sort || sort==''){\n                this.fail(403,'文章分类不能为空');\n                return false;\n            }\n            if(!title || title==''){\n                this.fail(403,'文章标题不能为空');\n                return false;\n            }\n            if(!content||content==''){\n                this.fail(403,'文章内容不能为空');\n                return false;\n            }\n\t        //取出内容中的img 标签 地址\n\n\t        //let commonFunion=new commonFun(); //需要new一下才能用\n\t        //let imgSrc=commonFunion.getSrc(content);  不需要从内容中提取图片\n\n            let data={\n                sort:sort,\n                title:title,\n                subTitle:subTitle,\n                intro:intro,\n                author:author,\n                content:content,\n                copyfrom:copyfrom,\n\t            thumb:thumb\n            };\n\n            if(editId!=0 || editId!='0'){//编辑文章\n\t            let newsThumb=await this.modelInstance.where({'article_id':editId}).field('thumb').find();\n\t            if(thumb!=newsThumb.thumb){ //如果提交过来的图片路径和数据库的不一致，则是修改了图片\n\t\t            // 检测文件是否存在\n\t\t            /*let filePath=think.ROOT_PATH+'/www'+slide_img.slide_img;  //图片的路径\n\t\t             if(fs.existsSync(filePath)) { //如果存在则删除图片\n\t\t             fs.unlinkSync(filePath);\n\t\t             }*/\n\t\t            //从先删除已经存在的图片\n\t\t            let slideshow=think.service('slideshow', 'admin');\n\t\t            let result=await slideshow.deleteQiniuImg(newsThumb.thumb);\n\n\t            }\n\n\n                let artitleId=await this.modelInstance.where({'article_id':editId}).editNews(data);\n\n                if(!artitleId){\n                    this.fail(403,'编辑文章失败');\n                }\n                else{\n                    this.success({data:artitleId},'编辑文章成功');\n                }\n            }else{//新增文章\n                let artitleId=await this.modelInstance.addArticle(data);\n                if(!artitleId){\n                    this.fail(403,'添加文章失败');\n                }\n                else{\n                    this.success({data:artitleId},'添加文章成功');\n                }\n            }\n\n\n        }\n    }\n    /*\n    * 删除文章\n    * */\n    async deleteAction(){\n    \t//删除文章时 需同时删除上传的图片\n        if(this.isGet){\n            let newsId=this.get('news-id');\n\t        let news_img=await this.modelInstance.where({'article_id':newsId}).field('thumb').find();\n\n\t        //循环遍历对象\n\t        if(news_img){\n\t\t        for (let i in news_img) {\n\t\t\t        if (news_img.hasOwnProperty(i) === true) {\n\t\t\t\t        // 检测文件是否存在 删除大图和缩略图\n\t\t\t\t        let filePath=think.ROOT_PATH+'/www'+news_img[i];  //图片的路径\n\t\t\t\t        if(fs.existsSync(filePath)) { //如果存在则删除图片\n\t\t\t\t\t        fs.unlinkSync(filePath);\n\t\t\t\t        }\n\t\t\t        }\n\t\t        }\n\t        }\n\n            let dataId=await this.modelInstance.where({'article_id':newsId}).delete();\n            if(!dataId){\n                this.fail(403,'删除文章失败');\n            }\n            else{\n                this.success({data:dataId},'删除文章成功');\n            }\n        }\n    }\n\t/*\n\t * 关闭浏览器时若没有点击提交按钮，则清除已经上传的图片\n\t * */\n\tasync cleanImgAction(){\n\t\tlet imgUrl=this.get('imgUrl');\n\t\tif(!imgUrl){\n\t\t\treturn false;\n\t\t}\n\t\tlet slide_img=await this.modelInstance.where({'thumb':imgUrl}).select();\n\n\t\tif(slide_img.length<=0){ //如果数据库里找不到，则是用户还没保存此文章，那么此时用户离开了浏览器，则需要删除七牛的已经上传的文件\n\t\t\tlet slideshow=think.service('slideshow', 'admin');\n\t\t\tlet result=await slideshow.deleteQiniuImg(imgUrl);\n\t\t}\n\n\t}\n};\n"
    ]
}